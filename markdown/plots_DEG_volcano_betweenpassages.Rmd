---
title: "Volcano Plots - between passages"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

## Switch working directory to project dir

knitr::opts_knit$set(root.dir = '..')
```

```{r Setup, include=FALSE}
# Load data
source("./scripts/env_prep.R")
source("./scripts/dge_cellpops_as_fixed.R")

# Define conditions of interest

conditions_interest <- c(
  "P5D3Untreated",
  "P7D3Untreated",
  "P13D3Untreated"
)

```

# Between passages, Day 3, untreated

## 3D volcano plots

```{r echo=FALSE, warning=FALSE}

design_D3 <- table_design

design_D3$condition_ID <- factor(design_D3$condition_ID,
          levels = c("P5D3Untreated",
                     "P7D3Untreated",
                     "P13D3Untreated"),
          labels = c("5",
                     "7",
                     "13"))

polar_pvals <- cbind(
  topTable(fit_contrasts,           number = Inf, sort.by = "none")$P.Value,
  topTable(fit_contrasts, coef = 13, number = Inf, sort.by = "none")$P.Value,
  topTable(fit_contrasts, coef = 15, number = Inf, sort.by = "none")$P.Value,
  topTable(fit_contrasts, coef = 14, number = Inf, sort.by = "none")$P.Value
)

polar_padj <- cbind(
  topTable(fit_contrasts,           number = Inf, sort.by = "none")$adj.P.Val,
  topTable(fit_contrasts, coef = 13, number = Inf, sort.by = "none")$adj.P.Val,
  topTable(fit_contrasts, coef = 15, number = Inf, sort.by = "none")$adj.P.Val,
  topTable(fit_contrasts, coef = 14, number = Inf, sort.by = "none")$adj.P.Val
)

## Construct volcano3d object

rownames(quant_DGE_voom$E) <- quant_DGE_voom$genes$GENENAME

polar_manual <- polar_coords(
  outcome = design_D3$condition_ID,
  data = t(quant_DGE_voom$E),
  pvals = polar_pvals,
  padj = polar_padj
)


## Plot

volcano3D(polar_manual,
              axis_angle = 3/6,
              label_size = 20,
              axis_label_size = 18,
          axis_title_size = 28)

```

**Legend***:* 3D cylindrical volcano plot summarising DEGs between hMSC growth phases. Z-scores of mean logCPM values were calculated then projected onto polar coordinates along 3 axes (A, B, C) in the x-y plane. Each axis represents one hMSC growth phase. Z-axis shows -log10 p-values derived from linear model fit. Significant genes were color-coded based on pairwise statistical tests, corrected for multiple comparisons. Passages 5, 7, 13 were shortened to P+5, P+7, P+1 on the plot.

## Between P+5 and P+7

```{r}

glimmaVolcano(x = fit_contrasts,
              counts = quant_DGE_voom[,quant_DGE_voom$targets$condition_ID %in% conditions_interest]$E,
              groups = quant_DGE_voom[,quant_DGE_voom$targets$condition_ID %in% conditions_interest]$targets$condition_ID,
              xlab = "logFC",
              transform.counts = "none",
              coef = 13)

```

## Between P+7 and P+13

```{r}

glimmaVolcano(x = fit_contrasts,
              counts = quant_DGE_voom[,quant_DGE_voom$targets$condition_ID %in% conditions_interest]$E,
              groups = quant_DGE_voom[,quant_DGE_voom$targets$condition_ID %in% conditions_interest]$targets$condition_ID,
              xlab = "logFC",
              transform.counts = "none",
              coef = 14)

```

## Between P+5 and P+13

```{r}

glimmaVolcano(x = fit_contrasts,
              counts = quant_DGE_voom[,quant_DGE_voom$targets$condition_ID %in% conditions_interest]$E,
              groups = quant_DGE_voom[,quant_DGE_voom$targets$condition_ID %in% conditions_interest]$targets$condition_ID,
              xlab = "logFC",
              transform.counts = "none",
              coef = 15)

```
