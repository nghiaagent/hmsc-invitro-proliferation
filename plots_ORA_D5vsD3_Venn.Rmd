---
title: "Overrepresentation Analysis - D5 vs D3 - Treated vs. Untreated"
author: "Mitch"
date: "2024-01-17"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(dpi=300,fig.width=36, fig.height = 12)
```

```{r Load data, include=FALSE}
# Load packages

source("./scripts/env_prep.R")

# Construct file paths

path_construct <- function(condition) {
  file.path(getwd(),
            'output',
            'data_enrichment',
            'ORA',
            condition,
            'ORA_results.RDS')
}

# Load data for D5 vs D3 Venn analysis

## Phase A

P5_Overlap_ORA <- readRDS(path_construct('D5vsD3_P5_Overlap'))

P5_Untreated_only_ORA <- readRDS(path_construct('D5vsD3_P5_Untreated_only'))

P5_Treated_only_ORA <- readRDS(path_construct('D5vsD3_P5_Treated_only'))

## Phase B

P7_Overlap_ORA <- readRDS(path_construct('D5vsD3_P7_Overlap'))

P7_Untreated_only_ORA <- readRDS(path_construct('D5vsD3_P7_Untreated_only'))

```

```{r Define plot function-Phase A + B, include=FALSE}

plot_ORA_trio <- function(enrichResults_a,
                          enrichResults_b,
                          enrichResults_c,
                          title) {
  plot_title <- ggdraw() +
    draw_label(title,
               fontface = 'bold')
  
  message(str_c("\nDrawing dot plot",
                title,
                sep = " "))
  
  dotplot <-
    plot_grid(
      dotplot(enrichResults_a, showCategory = 30),
      dotplot(enrichResults_b, showCategory = 30),
      dotplot(enrichResults_c, showCategory = 30),
      ncol = 3,
      nrow = 1
    )
  
  message(str_c("\nDrawing Gene-Concept Network plot",
                title,
                sep = " "))
  
  cnetplot <-
    plot_grid(
      cnetplot(enrichResults_a, showCategory = 8),
      cnetplot(enrichResults_b, showCategory = 8),
      cnetplot(enrichResults_c, showCategory = 8),
      ncol = 3,
      nrow = 1
    )
  
  
  message(str_c("\nDrawing Enrichment Map",
                title,
                sep = " "))
  
  emapplot <-
    plot_grid(
      emapplot(enrichplot::pairwise_termsim(enrichResults_a)),
      emapplot(enrichplot::pairwise_termsim(enrichResults_b)),
      emapplot(
        enrichplot::pairwise_termsim(enrichResults_c) %>%
          pairwise_termsim()
      ),
      ncol = 3,
      nrow = 1
      
    )
  
  
  message(str_c("\nDrawing UpSet plot",
                title,
                sep = " "))
  
  upsetplot <- plot_grid(
    enrichplot::upsetplot(enrichResults_a),
    enrichplot::upsetplot(enrichResults_b),
    enrichplot::upsetplot(enrichResults_c),
    ncol = 1,
    nrow = 3
  )
  
  message(str_c("\nDrawing Similarity space plot",
                title,
                sep = " "))
  
  message(str_c("\nExporting plots",
                title,
                sep = " "))
  
  list(
    "dotplot" = plot_grid(
      plot_title,
      dotplot,
      ncol = 1,
      rel_heights = c(0.1, 1)
    ),
    "cnetplot" = plot_grid(
      plot_title,
      cnetplot,
      ncol = 1,
      rel_heights = c(0.1, 1)
    ),
    "emapplot" = plot_grid(
      plot_title,
      emapplot,
      ncol = 1,
      rel_heights = c(0.1, 1)
    ),
    "upsetplot" = plot_grid(
      plot_title,
      upsetplot,
      ncol = 1,
      rel_heights = c(0.1, 1)
    )
  )
}

plot_ORA_duo <- function(enrichResults_a,
                         enrichResults_b,
                         title) {
  plot_title <- ggdraw() +
    draw_label(title,
               fontface = 'bold')
  
  message(str_c("\nDrawing dot plot",
                title,
                sep = " "))
  
  dotplot <-
    plot_grid(
      dotplot(enrichResults_a, showCategory = 30),
      dotplot(enrichResults_b, showCategory = 30),
      ncol = 2,
      nrow = 1
    )
  
  message(str_c("\nDrawing Gene-Concept Network plot",
                title,
                sep = " "))
  
  cnetplot <-
    plot_grid(
      cnetplot(enrichResults_a, showCategory = 8),
      cnetplot(enrichResults_b, showCategory = 8),
      ncol = 2,
      nrow = 1
    )
  
  
  message(str_c("\nDrawing Enrichment Map",
                title,
                sep = " "))
  
  emapplot <-
    plot_grid(
      emapplot(enrichplot::pairwise_termsim(enrichResults_a)),
      emapplot(enrichplot::pairwise_termsim(enrichResults_b)),
      ncol = 2,
      nrow = 1
      
    )
  
  
  message(str_c("\nDrawing UpSet plot",
                title,
                sep = " "))
  
  upsetplot <- plot_grid(
    enrichplot::upsetplot(enrichResults_a),
    enrichplot::upsetplot(enrichResults_b),
    ncol = 1,
    nrow = 2
  )
  
  message(str_c("\nDrawing Similarity space plot",
                title,
                sep = " "))
  
  message(str_c("\nExporting plots",
                title,
                sep = " "))
  
  list(
    "dotplot" = plot_grid(
      plot_title,
      dotplot,
      ncol = 1,
      rel_heights = c(0.1, 1)
    ),
    "cnetplot" = plot_grid(
      plot_title,
      cnetplot,
      ncol = 1,
      rel_heights = c(0.1, 1)
    ),
    "emapplot" = plot_grid(
      plot_title,
      emapplot,
      ncol = 1,
      rel_heights = c(0.1, 1)
    ),
    "upsetplot" = plot_grid(
      plot_title,
      upsetplot,
      ncol = 1,
      rel_heights = c(0.1, 1)
    )
  )
}


plot_ORA_single <- function(enrichResults_a,
                            title) {
  plot_title <- ggdraw() +
    draw_label(title,
               fontface = 'bold')
  
  message(str_c("\nDrawing dot plot",
                title,
                sep = " "))
  
  dotplot <-
    plot_grid(dotplot(enrichResults_a, showCategory = 30),
              ncol = 1,
              nrow = 1)
  
  message(str_c("\nDrawing Gene-Concept Network plot",
                title,
                sep = " "))
  
  cnetplot <-
    plot_grid(cnetplot(enrichResults_a, showCategory = 8),
              ncol = 1,
              nrow = 1)
  
  
  message(str_c("\nDrawing Enrichment Map",
                title,
                sep = " "))
  
  emapplot <-
    plot_grid(emapplot(enrichplot::pairwise_termsim(enrichResults_a)),
              ncol = 1,
              nrow = 1)
  
  
  message(str_c("\nDrawing UpSet plot",
                title,
                sep = " "))
  
  upsetplot <- plot_grid(enrichplot::upsetplot(enrichResults_a),
                         ncol = 1,
                         nrow = 2)
  
  message(str_c("\nDrawing Similarity space plot",
                title,
                sep = " "))
  
  ssplot <- plot_grid(
    enrichplot::ssplot(
      enrichplot::pairwise_termsim(enrichResults_a),
      show_category = Inf
    ),
    ncol = 1,
    nrow = 1
  )
  
  
  message(str_c("\nExporting plots",
                title,
                sep = " "))
  
  list(
    "dotplot" = plot_grid(
      plot_title,
      dotplot,
      ncol = 1,
      rel_heights = c(0.1, 1)
    ),
    "cnetplot" = plot_grid(
      plot_title,
      cnetplot,
      ncol = 1,
      rel_heights = c(0.1, 1)
    ),
    "emapplot" = plot_grid(
      plot_title,
      emapplot,
      ncol = 1,
      rel_heights = c(0.1, 1)
    ),
    "upsetplot" = plot_grid(
      plot_title,
      upsetplot,
      ncol = 1,
      rel_heights = c(0.1, 1)
    ),
    "ssplot" = plot_grid(
      plot_title,
      ssplot,
      ncol = 1,
      rel_heights = c(0.1, 1)
    )
  )
}


```

# Methods overview

After statistical analysis, Venn analysis was performed between genes differentially expressed between Days 3 and 5 in untreated cells and Days 3 and 5 in treated cells. Venn analysis was repeated at all 3 hMSC growth phases, in total deriving 5 list of DEGs suitable for Overrepresentation Analysis (ORA).

ORA was performed against the following datasets:

-   GO

    -   Biological Processes

    -   Cellular Component

    -   Molecular Function

-   MSigDB

    -   h: Hallmark

    -   c2: Curated

    -   c3: Regulatory targets

    -   c5: GO

-   ReactomePA

-   KEGG

Gene lists:

-   Phase A

    -   Untreated only

    -   Overlap

    -   Treated only

-   Phase B

    -   Untreated only

    -   Overlap

![](attachments/Picture1.png){width="50%"}

# GO

## BP

### Phase A / Passage+5

```{r}

plots <- plot_ORA_trio(P5_Untreated_only_ORA$GOBP,
                       P5_Overlap_ORA$GOBP,
                       P5_Treated_only_ORA$GOBP,
                       title = "Phase A - GO Biological Processes")

plot(plots$dotplot)

plot(plots$cnetplot)

plot(plots$emapplot)

plot(plots$upsetplot)

```

### Phase B / Passage+7

```{r}

plots <- plot_ORA_duo(P7_Untreated_only_ORA$GOBP,
                      P7_Overlap_ORA$GOBP,
                      title = "Phase B - GO Biological Processes")

plot(plots$dotplot)

plot(plots$cnetplot)

plot(plots$emapplot)

plot(plots$upsetplot)

```

## CC

### Phase A / Passage+5

```{r}

plots <- plot_ORA_trio(P5_Untreated_only_ORA$GOCC,
                       P5_Overlap_ORA$GOCC,
                       P5_Treated_only_ORA$GOCC,
                       title = "Phase A - GO Cellular Component")

plot(plots$dotplot)

plot(plots$cnetplot)

plot(plots$emapplot)

plot(plots$upsetplot)

```

### Phase B / Passage+7

```{r}

plots <- plot_ORA_duo(P7_Untreated_only_ORA$GOCC,
                      P7_Overlap_ORA$GOCC,
                      title = "Phase B - GO Cellular Component")

plot(plots$dotplot)

plot(plots$cnetplot)

plot(plots$emapplot)

plot(plots$upsetplot)

```

## MF

### Phase A / Passage+5

```{r}

plots <- plot_ORA_trio(P5_Untreated_only_ORA$GOMF,
                       P5_Overlap_ORA$GOMF,
                       P5_Treated_only_ORA$GOMF,
                       title = "Phase A - GO Molecular Function")

plot(plots$dotplot)

plot(plots$cnetplot)

plot(plots$emapplot)

plot(plots$upsetplot)
```

### Phase B / Passage+7

```{r}

plots <- plot_ORA_duo(P7_Untreated_only_ORA$GOMF,
                      P7_Overlap_ORA$GOMF,
                      title = "Phase B - GO Molecular Function")

plot(plots$dotplot)

plot(plots$cnetplot)

plot(plots$emapplot)

plot(plots$upsetplot)
```

# MSigDB

## h

### Phase A / Passage+5

```{r}

plots <- plot_ORA_trio(P5_Untreated_only_ORA$MSigDB_h,
                       P5_Overlap_ORA$MSigDB_h,
                       P5_Treated_only_ORA$MSigDB_h,
                       title = "Phase A - MSigDB_h")

plot(plots$dotplot)

plot(plots$cnetplot)

plot(plots$emapplot)

plot(plots$upsetplot)

```

### Phase B / Passage+7

```{r}

plots <- plot_ORA_duo(P7_Untreated_only_ORA$MSigDB_h,
                      P7_Overlap_ORA$MSigDB_h,
                      title = "Phase B - MSigDB_h")

plot(plots$dotplot)

plot(plots$cnetplot)

plot(plots$emapplot)

plot(plots$upsetplot)

```

## c2

### Phase A / Passage+5

```{r}

plots <- plot_ORA_trio(P5_Untreated_only_ORA$MSigDB_c2,
                       P5_Overlap_ORA$MSigDB_c2,
                       P5_Treated_only_ORA$MSigDB_c2,
                       title = "Phase A - MSigDB_c2")

plot(plots$dotplot)

plot(plots$cnetplot)

plot(plots$emapplot)

plot(plots$upsetplot)

```

### Phase B / Passage+7

```{r}

plots <- plot_ORA_duo(P7_Untreated_only_ORA$MSigDB_c2,
                      P7_Overlap_ORA$MSigDB_c2,
                      title = "Phase B - MSigDB_c2")

plot(plots$dotplot)

plot(plots$cnetplot)

plot(plots$emapplot)

plot(plots$upsetplot)

```

## c3

### Phase A / Passage+5

```{r}

plots <- plot_ORA_duo(P5_Overlap_ORA$MSigDB_c3,
                      P5_Treated_only_ORA$MSigDB_c3,
                      title = "Phase A - MSigDB_c3")

plot(plots$dotplot)

plot(plots$cnetplot)

plot(plots$emapplot)

plot(plots$upsetplot)

```

### Phase B / Passage+7

```{r}

plots <- plot_ORA_duo(P7_Untreated_only_ORA$MSigDB_c3,
                      P7_Overlap_ORA$MSigDB_c3,
                      title = "Phase B - MSigDB_c3")

plot(plots$dotplot)

plot(plots$cnetplot)

plot(plots$emapplot)

plot(plots$upsetplot)

```

## c5

### Phase A / Passage+5

```{r}

plots <- plot_ORA_trio(P5_Untreated_only_ORA$MSigDB_c5,
                       P5_Overlap_ORA$MSigDB_c5,
                       P5_Treated_only_ORA$MSigDB_c5,
                       title = "Phase A - MSigDB_c5")

plot(plots$dotplot)

plot(plots$cnetplot)

plot(plots$emapplot)

plot(plots$upsetplot)
```

### Phase B / Passage+7

```{r}

plots <- plot_ORA_duo(P7_Untreated_only_ORA$MSigDB_c5,
                      P7_Overlap_ORA$MSigDB_c5,
                      title = "Phase B - MSigDB_c5")

plot(plots$dotplot)

plot(plots$cnetplot)

plot(plots$emapplot)

plot(plots$upsetplot)
```

# ReactomePA

### Phase A / Passage+5

```{r}

plots <- plot_ORA_trio(P5_Untreated_only_ORA$Reactome,
                       P5_Overlap_ORA$Reactome,
                       P5_Treated_only_ORA$Reactome,
                       title = "Phase A - Reactome")

plot(plots$dotplot)

plot(plots$cnetplot)

plot(plots$emapplot)

plot(plots$upsetplot)
```

### Phase B / Passage+7

```{r}

plots <- plot_ORA_duo(P7_Untreated_only_ORA$Reactome,
                      P7_Overlap_ORA$Reactome,
                      title = "Phase B - Reactome")

plot(plots$dotplot)

plot(plots$cnetplot)

plot(plots$emapplot)

plot(plots$upsetplot)
```

# KEGG

### Phase A / Passage+5

```{r}

plots <- plot_ORA_duo(P5_Untreated_only_ORA$KEGG,
                       P5_Overlap_ORA$KEGG,
                       title = "Phase A - KEGG")

plot(plots$dotplot)

plot(plots$cnetplot)

plot(plots$emapplot)

plot(plots$upsetplot)
```

### Phase B / Passage+7

```{r}

plots <- plot_ORA_duo(P7_Untreated_only_ORA$KEGG,
                      P7_Overlap_ORA$KEGG,
                      title = "Phase B - KEGG")

plot(plots$dotplot)

plot(plots$cnetplot)

plot(plots$emapplot)

plot(plots$upsetplot)
```
